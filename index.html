<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Smart Remote</title>

<!-- No zoom -->
<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }

html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;        /* no page scroll */
  background: #0b0b0b;
  color: #fff;
  touch-action: manipulation;
}

/* App */
.app {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Top Bar */
.topbar {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid #2a2a2a;
}

.project-status {
  color: #3ad16f;
  font-size: 14px;
}

.screen-select {
  background: #111;
  border: 1px solid #444;
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
}

/* Editable code */
.remote-code {
  display: flex;
  gap: 6px;
}

.code-input {
  width: 32px;
  height: 32px;
  border: 1px solid #666;
  border-radius: 6px;
  text-align: center;
  background: #111;
  color: #fff;
  font-size: 16px;
}

/* Main Layout */
.main {
  flex: 1;
  display: flex;
  gap: 12px;
  padding: 12px;
  overflow: hidden; /* prevents page scroll */
}

/* Sidebar */
.sidebar {
  width: 180px;
  border: 1px solid #333;
  border-radius: 14px;
  padding: 8px;
  overflow: hidden;
}

.menu-item {
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
}

.menu-item.active {
  background: #0f3d1f;
  border: 1px solid #2bd46a;
}

.menu-item:hover {
  background: #1a1a1a;
}

/* Center Content (only scrollable area) */
.content {
  flex: 1;
  border: 1px solid #333;
  border-radius: 14px;
  padding: 12px;
  overflow-y: auto; /* only this scrolls */
  -webkit-overflow-scrolling: touch;
}

/* Touchpad panel */
.touchpad-panel {
  width: 220px;
  border: 1px solid #333;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #888;
  font-size: 18px;
  flex-shrink: 0;
}

/* Amenities */
.section-title {
  font-size: 18px;
  margin-bottom: 10px;
}

.amenity-btn {
  width: 100%;
  text-align: left;
  padding: 14px;
  margin-bottom: 10px;
  background: #111;
  border: 1px solid #555;
  border-radius: 10px;
  color: #fff;
  cursor: pointer;
}

.amenity-btn:hover {
  background: #1a1a1a;
}

.empty {
  text-align: center;
  color: #888;
  margin-top: 40px;
}
</style>
</head>

<body>
<div class="app">

  <!-- Top Bar -->
  <div class="topbar">
    <div class="project-status" id="projectStatus">
      Not connected
    </div>

    <select id="displaySelect" class="screen-select"></select>

    <div class="remote-code" id="remoteCodeInputs">
      <input class="code-input" maxlength="1">
      <input class="code-input" maxlength="1">
      <input class="code-input" maxlength="1">
      <input class="code-input" maxlength="1">
    </div>
  </div>

  <!-- Main -->
  <div class="main">

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="menu-item active" data-section="amenities">Amenities</div>
      <div class="menu-item" data-section="homes">Homes Search</div>
      <div class="menu-item" data-section="location">Location</div>
    </div>

    <!-- Center -->
    <div class="content">
      <div id="contentArea"></div>
    </div>

    <!-- Right -->
    <div class="touchpad-panel">
      Touchpad
    </div>

  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let pairedCode = null;
let projectName = null;
let remoteUiState = null;
let availableDisplays = [];
let activeSection = "amenities";

/* Sidebar */
document.querySelectorAll(".menu-item").forEach(item => {
  item.onclick = () => {
    document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
    item.classList.add("active");
    activeSection = item.dataset.section;
    renderSection();
  };
});

function renderSection() {
  const content = document.getElementById("contentArea");
  content.innerHTML = "";

  if (activeSection === "amenities") {
    content.innerHTML = `<div class="section-title">Amenities</div><div id="amenities"></div>`;
    renderAmenities();
  }

  if (activeSection === "homes") {
    content.innerHTML = `<div class="section-title">Homes Search</div><div id="homeSearch"></div>`;
    renderHomeSearch();
  }
}

/* Code Inputs */
const inputs = document.querySelectorAll(".code-input");

inputs.forEach((input, index) => {
  input.addEventListener("input", () => {
    input.value = input.value.replace(/[^0-9]/g, "");
    if (input.value && index < inputs.length - 1) {
      inputs[index + 1].focus();
    }
    checkAndPair();
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" && !input.value && index > 0) {
      inputs[index - 1].focus();
    }
  });
});

function getEnteredCode() {
  return Array.from(inputs).map(i => i.value).join("");
}

function setCodeInputs(code) {
  inputs.forEach(i => i.value = "");
  code.split("").forEach((c, i) => {
    if (inputs[i]) inputs[i].value = c;
  });
}

function clearCodeInputs() {
  inputs.forEach(i => i.value = "");
  inputs[0].focus();
}

/* Prevent pairing if display is busy */
function isDisplayBusy(code) {
  const d = availableDisplays.find(x => x.code === code);
  if (!d) return false;
  return d.isOccupied && code !== pairedCode;
}

function checkAndPair() {
  const code = getEnteredCode();
  if (code.length !== 4) return;

  // block busy
  if (isDisplayBusy(code)) {
    alert("Display is currently in use");
    clearCodeInputs();
    return;
  }

  socket.emit("pair_remote", { code });
}

/* Auto from URL */
const params = new URLSearchParams(window.location.search);
const codeFromUrl = params.get("code");
if (codeFromUrl && codeFromUrl.length === 4) {
  setCodeInputs(codeFromUrl);
  socket.emit("pair_remote", { code: codeFromUrl });
}

/* Socket */

// Pair success
socket.on("pair_success", ({ code, projectName: projName, displays }) => {
  pairedCode = code;
  projectName = projName;
  availableDisplays = displays;

  document.getElementById("projectStatus").textContent =
    "Connected to " + projName;

  updateDisplaySelector(displays, code);
});

// Switch success
socket.on("switch_success", ({ code, displays }) => {
  pairedCode = code;
  availableDisplays = displays;
  remoteUiState = null;

  updateDisplaySelector(displays, code);
  renderSection();
});

// Display state
socket.on("display_state", ({ state }) => {
  remoteUiState = state;
  renderSection();
});

// Display list update
socket.on("display_list_update", ({ displays }) => {
  availableDisplays = displays;
  updateDisplaySelector(displays, pairedCode);
});

// Pair error (busy / invalid)
socket.on("pair_error", ({ message }) => {
  alert(message);
  clearCodeInputs();
});

socket.on("switch_error", ({ message }) => {
  alert(message);
  updateDisplaySelector(availableDisplays, pairedCode);
});

/* Display dropdown */
function updateDisplaySelector(displays, currentCode) {
  const select = document.getElementById("displaySelect");
  select.innerHTML = "";

  displays.forEach(display => {
    const opt = document.createElement("option");
    opt.value = display.code;
    opt.textContent = display.displayName;

    // Disable if busy and not current
    if (display.isOccupied && display.code !== currentCode) {
      opt.disabled = true;
    }

    if (display.code === currentCode) opt.selected = true;
    select.appendChild(opt);
  });
}

document.getElementById("displaySelect").onchange = (e) => {
  const newCode = e.target.value;
  if (!newCode || newCode === pairedCode) return;

  // block busy
  if (isDisplayBusy(newCode)) {
    alert("Display is currently in use");
    updateDisplaySelector(availableDisplays, pairedCode);
    return;
  }

  socket.emit("switch_display", { newCode });
};

/* Amenities */
function renderAmenities() {
  const container = document.getElementById("amenities");
  if (!container) return;

  container.innerHTML = "";
  const amenityList = remoteUiState?.amenities || [];

  if (!amenityList.length) {
    container.innerHTML = '<div class="empty">No amenities found</div>';
    return;
  }

  amenityList.forEach(amenity => {
    const btn = document.createElement("button");
    btn.className = "amenity-btn";
    btn.textContent = amenity.amenity_name || `Amenity ${amenity.id}`;
    btn.onclick = () => {
      socket.emit("remote_command", {
        code: pairedCode,
        command: "amenity_select",
        payload: { id: amenity.id }
      });
    };
    container.appendChild(btn);
  });
}

/* Home Search */
function renderHomeSearch() {
  const container = document.getElementById("homeSearch");
  if (!container) return;

  container.innerHTML = "";
  const filters = remoteUiState?.firstLevelFilter?.selectedBuildings || [];

  if (!filters.length) {
    container.innerHTML = '<div class="empty">No search filters found</div>';
    return;
  }

  filters.forEach(filter => {
    const btn = document.createElement("button");
    btn.className = "amenity-btn";
    btn.textContent = filter.building_name || `Building ${filter.id}`;
    btn.onclick = () => {
      socket.emit("remote_command", {
        code: pairedCode,
        command: "home_search_filter",
        payload: { id: filter.id }
      });
    };
    container.appendChild(btn);
  });
}

renderSection();
</script>
