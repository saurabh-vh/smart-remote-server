<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Smart Remote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      body {
        margin: 0;
        padding: 16px;
        background: #f5f5f5;
      }

      .app {
        max-width: 420px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .project-info {
        background: #e8f4ff;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        text-align: center;
        border: 1px solid #b3d9ff;
        display: none;
      }

      .project-name {
        font-weight: 600;
        color: #007bff;
        font-size: 16px;
      }

      .pairing {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      #codeInput {
        flex: 1;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      #pairBtn {
        padding: 12px 16px;
        font-size: 16px;
        border-radius: 8px;
        border: none;
        background: #007bff;
        color: #fff;
        cursor: pointer;
        white-space: nowrap;
      }

      #pairBtn:active {
        opacity: 0.85;
      }

      .display-selector {
        margin-top: 12px;
        margin-bottom: 12px;
        display: none;
      }

      #displaySelect {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
      }

      .current-display {
        padding: 12px;
        background: #e8f4ff;
        border-radius: 8px;
        margin-bottom: 12px;
        text-align: center;
        font-weight: 500;
        color: #007bff;
        border: 1px solid #b3d9ff;
        display: none;
      }

      #amenities {
        margin-top: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 8px;
        -webkit-overflow-scrolling: touch;
      }

      .amenity-btn {
        display: block;
        width: 100%;
        text-align: left;
        padding: 14px 12px;
        margin-bottom: 8px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ddd;
        background: #f9f9f9;
        cursor: pointer;
      }

      .amenity-btn:last-child {
        margin-bottom: 0;
      }

      .amenity-btn:active {
        background: #eaeaea;
      }

      .empty {
        text-align: center;
        color: #777;
        padding: 16px;
      }

      .status {
        text-align: center;
        padding: 8px;
        margin-bottom: 12px;
        border-radius: 8px;
        font-size: 14px;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div id="projectInfo" class="project-info">
        Project: <span id="projectNameDisplay" class="project-name"></span>
      </div>

      <div class="pairing">
        <input id="codeInput" placeholder="Enter display code" />
        <button id="pairBtn">Pair</button>
      </div>

      <div id="status" class="status disconnected">Not Connected</div>

      <div class="display-selector">
        <select id="displaySelect">
          <option value="">Select a display to control...</option>
        </select>
      </div>

      <div id="currentDisplay" class="current-display">
        Controlling: <span id="displayName"></span>
      </div>

      <div id="amenities"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let pairedCode = null;
      let projectName = null;
      let remoteUiState = null;
      let availableDisplays = [];

      const params = new URLSearchParams(window.location.search);
      const codeFromUrl = params.get("code");
      
      if (codeFromUrl) {
        document.getElementById("codeInput").value = codeFromUrl;
        // When code is in URL, we don't know the project yet
        // The server will figure it out when we pair
      }

      socket.on("connect", () => {
        console.log("[remote] connected:", socket.id);
        updateStatus(true);
      });

      socket.on("disconnect", () => {
        updateStatus(false);
      });

      document.getElementById("pairBtn").addEventListener("click", () => {
        const code = document.getElementById("codeInput").value.trim();
        if (!code) return;
        
        // Send only the code - server will find which project it belongs to
        socket.emit("pair_remote", { code });
      });

      socket.on("pair_success", ({ code, projectName: projName, displays, currentDisplay }) => {
        pairedCode = code;
        projectName = projName;
        availableDisplays = displays;
        
        console.log("[remote] paired with:", code, "project:", projName);
        
        document.getElementById("status").textContent = `Connected to project: ${projName}`;
        document.getElementById("status").className = "status connected";
        
        // Update project info
        document.getElementById("projectNameDisplay").textContent = projName;
        document.getElementById("projectInfo").style.display = "block";
        
        updateDisplaySelector(displays, code);
        document.getElementById("displayName").textContent = currentDisplay;
        document.getElementById("currentDisplay").style.display = "block";
        document.querySelector(".display-selector").style.display = "block";
      });

      socket.on("pair_error", (data) => {
        alert(data.message);
      });

      socket.on("display_list_update", ({ displays }) => {
        // Only update if we have a project and the display list is for our project
        if (projectName && displays.length > 0 && displays[0].projectName === projectName) {
          availableDisplays = displays;
          updateDisplaySelector(displays, pairedCode);
        }
      });

      socket.on("display_state", ({ state, currentDisplay, currentDisplayCode, projectName: projName }) => {
        remoteUiState = state;
        if (currentDisplay) {
          document.getElementById("displayName").textContent = currentDisplay;
        }
        if (currentDisplayCode && currentDisplayCode !== pairedCode) {
          pairedCode = currentDisplayCode;
        }
        renderAmenities();
      });

      socket.on("switch_success", ({ code, displayName, displays }) => {
        pairedCode = code;
        availableDisplays = displays;
        document.getElementById("displayName").textContent = displayName;
        updateDisplaySelector(displays, code);
        alert(`Switched to ${displayName}`);
      });

      socket.on("switch_error", (data) => {
        alert(data.message);
      });

      function updateStatus(connected) {
        const statusEl = document.getElementById("status");
        if (connected) {
          statusEl.textContent = "Connected to Server";
          statusEl.className = "status connected";
        } else {
          statusEl.textContent = "Disconnected from Server";
          statusEl.className = "status disconnected";
        }
      }

      function updateDisplaySelector(displays, currentCode) {
        const select = document.getElementById("displaySelect");
        select.innerHTML = '<option value="">Select a display to control...</option>';
        
        // Filter displays for current project only (already filtered by server)
        displays.forEach(display => {
          const option = document.createElement("option");
          option.value = display.code;
          option.textContent = `${display.displayName} ${display.isOccupied ? '(Occupied)' : '(Available)'}`;
          option.disabled = display.isOccupied && display.code !== currentCode;
          if (display.code === currentCode) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      }

      document.getElementById("displaySelect").addEventListener("change", (e) => {
        const newCode = e.target.value;
        if (!newCode || newCode === pairedCode) return;
        
        if (!projectName) {
          alert("Not connected to a project");
          return;
        }
        
        socket.emit("switch_display", { newCode, projectName });
      });

      function renderAmenities() {
        const container = document.getElementById("amenities");
        container.innerHTML = "";

        const list = remoteUiState?.amenities || [];
        if (!Array.isArray(list) || list.length === 0) {
          container.innerHTML = '<div class="empty">No amenities found</div>';
          return;
        }

        list.forEach((amenity) => {
          const btn = document.createElement("button");
          btn.className = "amenity-btn";
          btn.textContent = amenity.amenity_name || `Amenity ${amenity.id}`;
          btn.onclick = () => {
            if (!pairedCode || !projectName) return;
            socket.emit("remote_command", {
              code: pairedCode,
              command: "amenity_select",
              payload: { id: amenity.id },
            });
          };
          container.appendChild(btn);
        });
      }

      // Auto-focus code input
      document.getElementById("codeInput").focus();
    </script>
  </body>
</html>