<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Smart Remote</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <!-- Global styles for Smart Remote UI (layout, sidebar, iPad-style components) -->
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="app" id="app">
      <!-- Pair Overlay -->
      <div class="pair-overlay">
        <div class="pair-box">
          <div>Enter connection code</div>
          <div class="remote-code" id="remoteCodeInputs">
            <input class="code-input" maxlength="1" />
            <input class="code-input" maxlength="1" />
            <input class="code-input" maxlength="1" />
            <input class="code-input" maxlength="1" />
          </div>
        </div>
      </div>

      <!-- Top -->
      <div class="topbar">
        <div class="project-status" id="projectStatus">Not connected</div>
        <select id="displaySelect" class="screen-select"></select>
      </div>

      <!-- Main -->
      <div class="main">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="sidebar-header">Remote</div>
          <div class="menu-item active" data-section="homes">Homes Search</div>
          <div class="menu-item" data-section="amenities">Amenities</div>
          <div class="menu-item" data-section="location">Location</div>
        </div>

        <!-- Content -->
        <div class="content">
          <div id="contentArea"></div>
        </div>

        <!-- Touchpad -->
        <!-- <div class="touchpad-panel">Touchpad</div> -->
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const appEl = document.getElementById("app");

      let pairedCode = null;
      let projectName = null;
      let remoteUiState = null;
      let selectedUnits = [];
      let homeUnitSearchQuery = "";
      let homeUnitTypeFilter = "";
      let availableDisplays = [];
      let activeSection = "homes";
      let activeHomeBuildingId = null;
      let activeAmenityId = null;
      let activeBuildingFlatId = null;

      /* =========================
                   URL Auto Connect
                ========================= */
      const params = new URLSearchParams(window.location.search);
      const codeFromUrl = params.get("code");

      if (codeFromUrl && codeFromUrl.length === 4) {
        const inputsAuto = document.querySelectorAll(".code-input");
        codeFromUrl.split("").forEach((c, i) => {
          if (inputsAuto[i]) inputsAuto[i].value = c;
        });

        socket.emit("pair_remote", { code: codeFromUrl });
      } else {
        appEl.classList.remove("connected");
      }

      /* =========================
         Handle top-level menu navigation (Homes / Amenities / Location)
         - Manage active tab UI
         - Reset section-specific state
         - Render correct section
         - Request fresh data from display
         ========================= */
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.onclick = () => {
          document
            .querySelectorAll(".menu-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");
          activeSection = item.dataset.section;

          // Reset home second-level state & when coming from another section
          if (activeSection === "homes") {
            selectedUnits = [];
            homeUnitSearchQuery = "";
            homeUnitTypeFilter = "";
            activeHomeBuildingId = null;
            activeBuildingFlatId = null;
          }

          // Reset amenities state when coming from another section
          if (activeSection === "amenities") {
            activeAmenityId = null;
          }

          renderSection();

          // When "Homes" section is selected
          // → Request homes data from display
          if (activeSection === "homes") {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "request_homes",
            });
          }

          // When "Amenities" section is selected
          // → Request homes data from display
          if (activeSection === "amenities") {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "request_homes",
            });
          }

          // When "Location" section is selected
          // → Request location data from display
          if (activeSection === "location") {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "request_location",
            });
          }
        };
      });

      /* =========================
                   Code Inputs
                ========================= */
      const inputs = document.querySelectorAll(".code-input");

      inputs.forEach((input, index) => {
        input.addEventListener("input", () => {
          input.value = input.value.replace(/[^0-9]/g, "");
          if (input.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
          checkAndPair();
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !input.value && index > 0) {
            inputs[index - 1].focus();
          }
        });
      });

      function getEnteredCode() {
        return Array.from(inputs)
          .map((i) => i.value)
          .join("");
      }

      function clearCodeInputs() {
        inputs.forEach((i) => (i.value = ""));
        inputs[0].focus();
      }

      function checkAndPair() {
        const code = getEnteredCode();
        if (code.length !== 4) return;
        socket.emit("pair_remote", { code });
      }

      /* =========================
                   Socket Events
                ========================= */

      socket.on("pair_success", ({ code, projectName: projName, displays }) => {
        pairedCode = code;
        projectName = projName;
        availableDisplays = displays;

        document.getElementById("projectStatus").textContent =
          "Connected to " + projName;

        appEl.classList.add("connected");

        updateDisplaySelector(displays, code);
      });

      socket.on("display_state", ({ state }) => {
        remoteUiState = state;
        renderSection();
      });
      socket.on("second_level_update", ({ selectedUnits: units = [] }) => {
        // console.log("[remote] second_level_update:", units);
        selectedUnits = units;
        homeUnitSearchQuery = "";
        homeUnitTypeFilter = "";
        if (isHomeSection()) renderSection();
      });

      socket.on("display_list_update", ({ displays }) => {
        availableDisplays = displays;
        updateDisplaySelector(displays, pairedCode);
      });

      socket.on("pair_error", ({ message }) => {
        alert(message);
        clearCodeInputs();
        appEl.classList.remove("connected");
      });

      /* =========================
                   Display dropdown (FIX)
                ========================= */
      function updateDisplaySelector(displays, currentCode) {
        const select = document.getElementById("displaySelect");
        select.innerHTML = "";

        displays.forEach((display) => {
          const opt = document.createElement("option");
          opt.value = display.code;
          opt.textContent = display.displayName;
          if (display.code === currentCode) opt.selected = true;
          select.appendChild(opt);
        });
      }

      // IMPORTANT: Switch display when user selects another
      document
        .getElementById("displaySelect")
        .addEventListener("change", (e) => {
          const newCode = e.target.value;
          if (!newCode || newCode === pairedCode) return;

          socket.emit("switch_display", {
            newCode,
            projectName,
          });
        });

      // Server confirms switch
      socket.on("switch_success", ({ code, displayName, displays }) => {
        pairedCode = code;
        availableDisplays = displays;

        document.getElementById("projectStatus").textContent =
          "Connected to " + projectName + " - " + displayName;

        updateDisplaySelector(displays, code);
      });

      /* =========================
         Section Renderer Controller
         -------------------------
         - Decides which section (Homes / Amenities / Location) is active
         - Clears previous section UI
         - Creates section layout (title + container)
         - Delegates actual list rendering to specific functions
           (renderHomeSearch, renderAmenities, etc.)
      ========================= */
      function renderSection() {
        const content = document.getElementById("contentArea");
        content.innerHTML = "";

        if (activeSection === "amenities") {
          content.innerHTML = `<div class="section-title">Amenities</div>
                       <div class="section-card" id="amenities"></div>`;
          renderAmenities();
        }

        if (isHomeSection()) {
          content.innerHTML = `<div class="section-title">Homes Search</div>
                       <div class="section-card" id="homeSearch"></div>`;
          renderHomeSearch();
        }
      }

      function isHomeSection() {
        return activeSection === "homes" || activeSection === "home";
      }

      // Amenities Logic & UI
      function renderAmenities() {
        const container = document.getElementById("amenities");
        // Reset list before re-render
        container.innerHTML = "";
        const list = remoteUiState?.amenities || [];

        if (!list.length) {
          container.innerHTML = '<div class="empty">No amenities found</div>';
          return;
        }

        list.forEach((a) => {
          const row = document.createElement("div");
          row.className = "list-row";

          if (a.id === activeAmenityId) {
            row.classList.add("active");
          }

          row.textContent = a.amenity_name || `Amenity ${a.id}`;

          row.onclick = () => {
            activeAmenityId = a.id;
            renderAmenities();
            socket.emit("remote_command", {
              code: pairedCode,
              command: "amenity_select",
              payload: { id: a.id },
            });
          };
          container.appendChild(row);
        });
      }

      // Home Search Logic & UI
      function renderHomeSearch() {
        const container = document.getElementById("homeSearch");
        // Reset list before re-render
        container.innerHTML = "";
        const selectedUnitsList = selectedUnits || [];

        if (selectedUnitsList.length) {
          const toolbar = document.createElement("div");
          toolbar.className = "list-row units-toolbar";

          const backBtn = document.createElement("div");
          backBtn.className = "units-back";
          backBtn.textContent = "\u2190";
          backBtn.onclick = () => {
            selectedUnits = [];
            homeUnitSearchQuery = "";
            homeUnitTypeFilter = "";
            socket.emit("remote_command", {
              code: pairedCode,
              command: "home_search_back",
            });
            renderSection();
          };

          const searchInput = document.createElement("input");
          searchInput.className = "units-search";
          searchInput.type = "text";
          searchInput.placeholder = "Search unit no.";
          searchInput.value = homeUnitSearchQuery;

          const typeFilter = document.createElement("select");
          typeFilter.className = "units-filter";
          const allOpt = document.createElement("option");
          allOpt.value = "";
          allOpt.textContent = "All types";
          typeFilter.appendChild(allOpt);

          const types = [
            ...new Set(
              selectedUnitsList
                .map((u) => getUnitTypeLabel(u.unit_type))
                .filter(Boolean),
            ),
          ];
          types.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            typeFilter.appendChild(opt);
          });
          typeFilter.value = homeUnitTypeFilter;

          toolbar.appendChild(backBtn);
          toolbar.appendChild(searchInput);
          toolbar.appendChild(typeFilter);
          container.appendChild(toolbar);

          const listWrap = document.createElement("div");
          container.appendChild(listWrap);

          const renderFilteredUnits = () => {
            const q = (homeUnitSearchQuery || "").trim().toLowerCase();
            const t = (homeUnitTypeFilter || "").trim().toLowerCase();

            const filtered = selectedUnitsList.filter((u) => {
              const unitNo = String(u.unique_unit_number || "").toLowerCase();
              const typeLabel = getUnitTypeLabel(u.unit_type).toLowerCase();
              const matchNo = !q || unitNo.includes(q);
              const matchType = !t || typeLabel === t;
              return matchNo && matchType;
            });

            listWrap.innerHTML = "";

            if (!filtered.length) {
              const empty = document.createElement("div");
              empty.className = "empty";
              empty.textContent = "No units found";
              listWrap.appendChild(empty);
              return;
            }

            filtered.forEach((u) => {
              const row = document.createElement("div");
              row.className = "list-row unit-row";

              // Active flat highlight
              if (u.unit_id === activeBuildingFlatId) {
                row.classList.add("active");
              }

              row.onclick = () => {
                activeBuildingFlatId = u.unit_id;
                renderHomeSearch();
                socket.emit("remote_command", {
                  code: pairedCode,
                  command: "go_to_unit",
                  payload: {
                    unit_id: u.unit_id,
                    unit_number: u.unique_unit_number,
                  },
                });
              };

              const left = document.createElement("div");
              left.className = "unit-left";
              left.textContent =
                u.unique_unit_number || u.unit_id || u.id || "-";

              const middle = document.createElement("div");
              middle.className = "unit-middle";

              const areaLine = document.createElement("div");
              areaLine.className = "unit-middle-line unit-area";
              const areaLabel = u.area_definition
                ? `${u.area_definition} Area`
                : "Area";
              const areaValue = u.area_of_unit ?? "-";
              const areaUnit = u.display_of_area_unit || "";
              areaLine.textContent = `${areaLabel}: ${areaValue} ${areaUnit}`;

              const divider = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "svg",
              );
              divider.setAttribute("class", "unit-divider");
              divider.setAttribute("viewBox", "0 0 240 10");
              divider.setAttribute("preserveAspectRatio", "none");
              divider.innerHTML = `
                          <line x1="24" y1="5" x2="216" y2="5" stroke="#d7dbe1" stroke-width="1.5" />

                        `;

              const directionLine = document.createElement("div");
              directionLine.className = "unit-middle-line unit-direction";
              directionLine.textContent = `Direction: ${u.unit_direction || "-"}`;

              middle.appendChild(areaLine);
              middle.appendChild(divider);
              middle.appendChild(directionLine);

              const badge = document.createElement("div");
              badge.className = "unit-badge";
              const typeLabel = getUnitTypeLabel(u.unit_type) || "Unit";
              badge.textContent = typeLabel;
              badge.style.backgroundColor = u.color_code || "#8a5a00";

              row.appendChild(left);
              row.appendChild(middle);
              row.appendChild(badge);
              listWrap.appendChild(row);
            });
          };

          searchInput.addEventListener("input", (e) => {
            homeUnitSearchQuery = e.target.value || "";
            renderFilteredUnits();
          });

          typeFilter.addEventListener("change", (e) => {
            homeUnitTypeFilter = e.target.value || "";
            renderFilteredUnits();
          });

          renderFilteredUnits();
          return;
        }

        const filters =
          remoteUiState?.firstLevelFilter?.selectedBuildings || [];

        if (!filters.length) {
          container.innerHTML =
            '<div class="empty">No search filters found</div>';
          return;
        }

        filters.forEach((f) => {
          const row = document.createElement("div");
          row.className = "list-row";

          if (f.id === activeHomeBuildingId) {
            row.classList.add("active");
          }

          row.textContent = f.building_name || `Building ${f.id}`;

          row.onclick = () => {
            activeHomeBuildingId = f.id;
            socket.emit("remote_command", {
              code: pairedCode,
              command: "home_search_filter",
              payload: { id: f.id },
            });
          };

          container.appendChild(row);
        });
      }

      function getUnitTypeLabel(unitType) {
        return (unitType || "").split("-")[0].trim();
      }

      renderSection();

      /* =========================
                   Touchpad Control
                ========================= */
      const touchpad = document.querySelector(".touchpad-panel");

      let lastX = null;
      let lastY = null;
      let touchStartTime = 0;

      touchpad.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        lastX = t.clientX;
        lastY = t.clientY;
        touchStartTime = Date.now();
      });

      touchpad.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!pairedCode) return;

        const t = e.touches[0];
        const dx = t.clientX - lastX;
        const dy = t.clientY - lastY;

        lastX = t.clientX;
        lastY = t.clientY;

        socket.emit("remote_command", {
          code: pairedCode,
          command: "touchpad_move",
          payload: { dx, dy },
        });
      });

      touchpad.addEventListener("touchend", () => {
        const duration = Date.now() - touchStartTime;

        if (pairedCode) {
          if (duration < 200) {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "touchpad_click",
            });
          } else {
            // release drag
            socket.emit("remote_command", {
              code: pairedCode,
              command: "touchpad_release",
            });
          }
        }

        lastX = null;
        lastY = null;
      });

      touchpad.addEventListener("click", () => {
        if (!pairedCode) return;

        socket.emit("remote_command", {
          code: pairedCode,
          command: "touchpad_click",
        });
      });
    </script>
  </body>
</html>
