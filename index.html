<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Smart Remote</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <style>
      * {
        box-sizing: border-box;
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
          sans-serif;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        background: #f2f2f7;
        color: #000;
        overflow: hidden;
      }

      /* App */
      .app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Top bar (iPad style) */
      .topbar {
        height: 54px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
      }

      .project-status {
        font-size: 14px;
        color: #666;
      }

      .screen-select {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
      }

      /* Layout */
      .main {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      /* Sidebar - iPad Settings style */
      .sidebar {
        width: 320px;
        background: #fff;
        border-right: 1px solid #ddd;
        overflow-y: auto;
      }

      .sidebar-header {
        font-size: 20px;
        font-weight: 600;
        padding: 16px;
      }

      .menu-item {
        padding: 14px 18px;
        font-size: 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }

      .menu-item.active {
        background: #e9f2ff;
        color: #007aff;
      }

      .menu-item:hover {
        background: #f5f5f7;
      }

      /* Content panel */
      .content {
        flex: 1;
        background: #f2f2f7;
        overflow-y: auto;
        padding: 24px;
      }

      /* Section Card (iPad grouped style) */
      .section-card {
        background: #fff;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      /* List rows */
      .list-row {
        padding: 16px;
        border-bottom: 1px solid #eee;
        font-size: 16px;
        cursor: pointer;
      }

      .list-row:last-child {
        border-bottom: none;
      }

      .list-row:active {
        background: #f2f2f7;
      }

      .units-back {
        font-weight: 600;
      }

      .unit-row {
        padding: 12px 16px;
        background: #fff;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .unit-left {
        min-width: 62px;
        font-size: 16px;
        line-height: 1.25;
        font-weight: 600;
        color: #1c1c1c;
        text-align: center;
      }

      .unit-middle {
        flex: 1;
        min-width: 0;
        text-align: center;
        color: #2a2a2a;
        font-size: 16px;
        line-height: 1.2;
      }

      .unit-middle-line {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .unit-divider {
        width: 100%;
        height: 10px;
        margin: 4px 0;
        display: block;
      }

      .unit-direction,
      .unit-area {
        font-size: 14px;
        color: #5f6368;
      }

      .unit-badge {
        min-width: 76px;
        text-align: center;
        color: #fff;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 16px;
        line-height: 1.2;
        font-weight: 600;
        white-space: nowrap;
      }

      .empty {
        text-align: center;
        margin-top: 40px;
        color: #888;
      }

      /* Touchpad */
      .touchpad-panel {
        width: 260px;
        background: #fff;
        border-left: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
      }

      /* Pair Box (center when not connected) */
      .pair-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: 0.3s;
      }

      .pair-box {
        background: #fff;
        padding: 24px;
        border-radius: 18px;
        text-align: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }

      .remote-code {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
      }

      .code-input {
        width: 56px;
        height: 56px;
        font-size: 24px;
        text-align: center;
        border-radius: 12px;
        border: 1px solid #ccc;
      }

      /* Connected state */
      .connected .pair-overlay {
        opacity: 0;
        pointer-events: none;
      }

      /* Responsive */
      @media (max-width: 900px) {
        .touchpad-panel {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div class="app" id="app">
      <!-- Pair Overlay -->
      <div class="pair-overlay">
        <div class="pair-box">
          <div>Enter connection code</div>
          <div class="remote-code" id="remoteCodeInputs">
            <input class="code-input" maxlength="1" />
            <input class="code-input" maxlength="1" />
            <input class="code-input" maxlength="1" />
            <input class="code-input" maxlength="1" />
          </div>
        </div>
      </div>

      <!-- Top -->
      <div class="topbar">
        <div class="project-status" id="projectStatus">Not connected</div>
        <select id="displaySelect" class="screen-select"></select>
      </div>

      <!-- Main -->
      <div class="main">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="sidebar-header">Remote</div>
          <div class="menu-item active" data-section="amenities">Amenities</div>
          <div class="menu-item" data-section="homes">Homes Search</div>
          <div class="menu-item" data-section="location">Location</div>
        </div>

        <!-- Content -->
        <div class="content">
          <div id="contentArea"></div>
        </div>

        <!-- Touchpad -->
        <div class="touchpad-panel">Touchpad</div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const appEl = document.getElementById("app");

      let pairedCode = null;
      let projectName = null;
      let remoteUiState = null;
      let selectedUnits = [];
      let availableDisplays = [];
      let activeSection = "amenities";

      /* =========================
       URL Auto Connect
    ========================= */
      const params = new URLSearchParams(window.location.search);
      const codeFromUrl = params.get("code");

      if (codeFromUrl && codeFromUrl.length === 4) {
        const inputsAuto = document.querySelectorAll(".code-input");
        codeFromUrl.split("").forEach((c, i) => {
          if (inputsAuto[i]) inputsAuto[i].value = c;
        });

        socket.emit("pair_remote", { code: codeFromUrl });
      } else {
        appEl.classList.remove("connected");
      }

      /* =========================
       Sidebar
    ========================= */
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.onclick = () => {
          document
            .querySelectorAll(".menu-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");
          activeSection = item.dataset.section;
          renderSection();

          if (activeSection === "location") {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "request_location",
            });
          }
        };
      });

      /* =========================
       Code Inputs
    ========================= */
      const inputs = document.querySelectorAll(".code-input");

      inputs.forEach((input, index) => {
        input.addEventListener("input", () => {
          input.value = input.value.replace(/[^0-9]/g, "");
          if (input.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
          checkAndPair();
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !input.value && index > 0) {
            inputs[index - 1].focus();
          }
        });
      });

      function getEnteredCode() {
        return Array.from(inputs)
          .map((i) => i.value)
          .join("");
      }

      function clearCodeInputs() {
        inputs.forEach((i) => (i.value = ""));
        inputs[0].focus();
      }

      function checkAndPair() {
        const code = getEnteredCode();
        if (code.length !== 4) return;
        socket.emit("pair_remote", { code });
      }

      /* =========================
       Socket Events
    ========================= */

      socket.on("pair_success", ({ code, projectName: projName, displays }) => {
        pairedCode = code;
        projectName = projName;
        availableDisplays = displays;

        document.getElementById("projectStatus").textContent =
          "Connected to " + projName;

        appEl.classList.add("connected");

        updateDisplaySelector(displays, code);
      });

      socket.on("display_state", ({ state }) => {
        remoteUiState = state;
        renderSection();
      });
      socket.on("second_level_update", ({ selectedUnits: units = [] }) => {
        console.log("[remote] second_level_update:", units);
        selectedUnits = units;
        if (isHomeSection()) renderSection();
      });

      socket.on("display_list_update", ({ displays }) => {
        availableDisplays = displays;
        updateDisplaySelector(displays, pairedCode);
      });

      socket.on("pair_error", ({ message }) => {
        alert(message);
        clearCodeInputs();
        appEl.classList.remove("connected");
      });

      /* =========================
       Display dropdown (FIX)
    ========================= */
      function updateDisplaySelector(displays, currentCode) {
        const select = document.getElementById("displaySelect");
        select.innerHTML = "";

        displays.forEach((display) => {
          const opt = document.createElement("option");
          opt.value = display.code;
          opt.textContent = display.displayName;
          if (display.code === currentCode) opt.selected = true;
          select.appendChild(opt);
        });
      }

      // IMPORTANT: Switch display when user selects another
      document
        .getElementById("displaySelect")
        .addEventListener("change", (e) => {
          const newCode = e.target.value;
          if (!newCode || newCode === pairedCode) return;

          socket.emit("switch_display", {
            newCode,
            projectName,
          });
        });

      // Server confirms switch
      socket.on("switch_success", ({ code, displayName, displays }) => {
        pairedCode = code;
        availableDisplays = displays;

        document.getElementById("projectStatus").textContent =
          "Connected to " + projectName + " - " + displayName;

        updateDisplaySelector(displays, code);
      });

      /* =========================
       Sections
    ========================= */
      function renderSection() {
        const content = document.getElementById("contentArea");
        content.innerHTML = "";

        if (activeSection === "amenities") {
          content.innerHTML = `<div class="section-title">Amenities</div>
           <div class="section-card" id="amenities"></div>`;
          renderAmenities();
        }

        if (isHomeSection()) {
          content.innerHTML = `<div class="section-title">Homes Search</div>
           <div class="section-card" id="homeSearch"></div>`;
          renderHomeSearch();
        }
      }

      function isHomeSection() {
        return activeSection === "homes" || activeSection === "home";
      }

      function renderAmenities() {
        const container = document.getElementById("amenities");
        const list = remoteUiState?.amenities || [];

        if (!list.length) {
          container.innerHTML = '<div class="empty">No amenities found</div>';
          return;
        }

        list.forEach((a) => {
          const row = document.createElement("div");
          row.className = "list-row";
          row.textContent = a.amenity_name || `Amenity ${a.id}`;
          row.onclick = () => {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "amenity_select",
              payload: { id: a.id },
            });
          };
          container.appendChild(row);
        });
      }

      function renderHomeSearch() {
        const container = document.getElementById("homeSearch");
        const selectedUnitsList = selectedUnits || [];

        if (selectedUnitsList.length) {
          const backRow = document.createElement("div");
          backRow.className = "list-row units-back";
          backRow.textContent = "\u2190 Back";
          backRow.onclick = () => {
            selectedUnits = [];
            renderSection();
          };
          container.appendChild(backRow);

          selectedUnitsList.forEach((u) => {
            const row = document.createElement("div");
            row.className = "list-row unit-row";

            const left = document.createElement("div");
            left.className = "unit-left";
            left.textContent = u.unique_unit_number || u.unit_id || u.id || "-";

            const middle = document.createElement("div");
            middle.className = "unit-middle";

            const areaLine = document.createElement("div");
            areaLine.className = "unit-middle-line unit-area";
            const areaLabel = u.area_definition
              ? `${u.area_definition} Area`
              : "Area";
            const areaValue = u.area_of_unit ?? "-";
            const areaUnit = u.display_of_area_unit || "";
            areaLine.textContent = `${areaLabel}: ${areaValue} ${areaUnit}`;

            const divider = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "svg"
            );
            divider.setAttribute("class", "unit-divider");
            divider.setAttribute("viewBox", "0 0 240 10");
            divider.setAttribute("preserveAspectRatio", "none");
            divider.innerHTML = `
              <line x1="24" y1="5" x2="216" y2="5" stroke="#d7dbe1" stroke-width="1.5" />
              
            `;

            const directionLine = document.createElement("div");
            directionLine.className = "unit-middle-line unit-direction";
            directionLine.textContent = `Direction: ${u.unit_direction || "-"}`;

            middle.appendChild(areaLine);
            middle.appendChild(divider);
            middle.appendChild(directionLine);

            const badge = document.createElement("div");
            badge.className = "unit-badge";
            const typeLabel = (u.unit_type || "Unit").split("-")[0].trim();
            badge.textContent = typeLabel;
            badge.style.backgroundColor = u.color_code || "#8a5a00";

            row.appendChild(left);
            row.appendChild(middle);
            row.appendChild(badge);
            container.appendChild(row);
          });
          return;
        }

        const filters =
          remoteUiState?.firstLevelFilter?.selectedBuildings || [];

        if (!filters.length) {
          container.innerHTML =
            '<div class="empty">No search filters found</div>';
          return;
        }

        filters.forEach((f) => {
          const row = document.createElement("div");
          row.className = "list-row";
          row.textContent = f.building_name || `Building ${f.id}`;
          row.onclick = () => {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "home_search_filter",
              payload: { id: f.id },
            });
          };
          container.appendChild(row);
        });
      }

      renderSection();

      /* =========================
       Touchpad Control
    ========================= */
      const touchpad = document.querySelector(".touchpad-panel");

      let lastX = null;
      let lastY = null;
      let touchStartTime = 0;

      touchpad.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        lastX = t.clientX;
        lastY = t.clientY;
        touchStartTime = Date.now();
      });

      touchpad.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!pairedCode) return;

        const t = e.touches[0];
        const dx = t.clientX - lastX;
        const dy = t.clientY - lastY;

        lastX = t.clientX;
        lastY = t.clientY;

        socket.emit("remote_command", {
          code: pairedCode,
          command: "touchpad_move",
          payload: { dx, dy },
        });
      });

      touchpad.addEventListener("touchend", () => {
        const duration = Date.now() - touchStartTime;

        if (pairedCode) {
          if (duration < 200) {
            socket.emit("remote_command", {
              code: pairedCode,
              command: "touchpad_click",
            });
          } else {
            // release drag
            socket.emit("remote_command", {
              code: pairedCode,
              command: "touchpad_release",
            });
          }
        }

        lastX = null;
        lastY = null;
      });

      touchpad.addEventListener("click", () => {
        if (!pairedCode) return;

        socket.emit("remote_command", {
          code: pairedCode,
          command: "touchpad_click",
        });
      });
    </script>
  </body>
</html>
